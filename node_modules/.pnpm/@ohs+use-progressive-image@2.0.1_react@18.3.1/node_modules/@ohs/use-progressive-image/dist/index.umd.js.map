{"version":3,"file":"index.umd.js","sources":["../src/index.ts"],"sourcesContent":["import {\n  useEffect, useState, useCallback,\n} from 'react';\nimport { useDeepCompareMemo } from 'use-deep-compare';\n\ntype ImgArg = {\n  sizes?: string;\n  src?: string;\n  srcSet?: string;\n}\ntype SourceArg = {\n  sizes?: string;\n  src?: string;\n  srcSet?: string;\n  type?: string;\n}\ntype SourcesArg = SourceArg[]\nexport type UseProgressiveImageArg = {\n  img?: ImgArg | string;\n  sources?: SourcesArg;\n  ssr?: boolean;\n}\nexport type UseProgressiveImageReturn = [\n  boolean,\n  Event | string | undefined,\n]\n\nconst isBrowser = typeof window !== 'undefined' && window.document && window.document.createElement;\n\n/**\n * Necessary to prevent mismatch between the client and server on initial render in ssr mode.\n */\nconst initImages = isBrowser ? Array.from(document.images) : []; // Live array, need to convert to a regular\nlet normInitImages: string[] | undefined;\nconst getLazyInitImages = (): string[] => {\n  if (!normInitImages) {\n    normInitImages = initImages.map((img) => img.src).filter((src) => !src.startsWith('data:image'));\n  }\n  return normInitImages;\n};\nconst isInitImage = (src: string | undefined): boolean => getLazyInitImages().some(\n  (initImgSrc) => src && initImgSrc?.endsWith(src),\n);\nconst isInitSsr = (isSsrMode = false, src?: string): boolean => {\n  if (isSsrMode && src && isBrowser && document.readyState !== 'complete' && isInitImage(src)) {\n    return true;\n  }\n  return false;\n};\n\nfunction normArg(obj: ImgArg): Omit<ImgArg, 'srcSet'> | { 'srcset': ImgArg['srcSet'] }\nfunction normArg(obj: SourceArg): Omit<SourceArg, 'srcSet'> | { 'srcset': SourceArg['srcSet'] }[]\nfunction normArg(obj: SourceArg): Omit<SourceArg, 'srcSet'> | { 'srcset': SourceArg['srcSet'] }[]\nfunction normArg(obj: any): any {\n  const normObj = { ...obj, srcset: obj.srcSet };\n  delete normObj.srcSet;\n  Object.keys(normObj).forEach((key) => {\n    if (normObj[key] === undefined) {\n      delete normObj[key];\n    }\n  });\n  return normObj;\n}\n\nconst useProgressiveImage = ({\n  img: imgArg,\n  sources: sourcesArg,\n  ssr = false,\n}: UseProgressiveImageArg): UseProgressiveImageReturn => {\n  const [, setRerender] = useState(false);\n  const [errorEvent, setErrorEvent] = useState<Event | string | undefined>(undefined);\n\n  const rerender = useCallback(() => {\n    setRerender((prev) => !prev);\n  }, []);\n\n  const handleError = useCallback((event: Event | string) => {\n    setErrorEvent(event);\n  }, []);\n\n  // eslint-disable-next-line consistent-return\n  const image = useDeepCompareMemo<HTMLImageElement | undefined>(() => {\n    const src = typeof imgArg === 'string' ? imgArg : imgArg?.src;\n    if (src && isBrowser && !isInitSsr(ssr, src)) {\n      const img = document.createElement('img');\n\n      if (sourcesArg && sourcesArg.length > 0) {\n        const pic = document.createElement('picture');\n        sourcesArg?.forEach((sourceProps) => {\n          const source = document.createElement('source');\n          Object.assign(source, normArg(sourceProps));\n          pic.appendChild(source);\n        });\n        pic?.appendChild(img);\n      }\n\n      img.onload = rerender;\n      img.onerror = handleError;\n      Object.assign(img, normArg(typeof imgArg === 'string' ? { src: imgArg } : imgArg!)); // eslint-disable-line @typescript-eslint/no-non-null-assertion\n      return img;\n    }\n  }, [imgArg, sourcesArg, rerender, handleError, ssr]);\n\n  useEffect(() => () => {\n    if (image) {\n      image.onload = null;\n      image.onerror = null;\n    }\n  }, [image]);\n\n  if (image?.complete || !image) {\n    return [false, errorEvent];\n  }\n  return [true, errorEvent];\n};\n\nexport default useProgressiveImage;\n"],"names":["isBrowser","window","document","createElement","initImages","Array","from","images","normInitImages","getLazyInitImages","map","img","src","filter","startsWith","isInitImage","some","initImgSrc","endsWith","isInitSsr","isSsrMode","readyState","normArg","obj","normObj","srcset","srcSet","Object","keys","forEach","key","undefined","useProgressiveImage","imgArg","sourcesArg","sources","ssr","useState","setRerender","errorEvent","setErrorEvent","rerender","useCallback","prev","handleError","event","image","useDeepCompareMemo","length","pic","sourceProps","source","assign","appendChild","onload","onerror","useEffect","complete"],"mappings":"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"}