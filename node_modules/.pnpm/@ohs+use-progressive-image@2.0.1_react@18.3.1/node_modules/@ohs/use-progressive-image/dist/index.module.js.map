{"version":3,"file":"index.module.js","sources":["../src/index.ts"],"sourcesContent":["import {\n  useEffect, useState, useCallback,\n} from 'react';\nimport { useDeepCompareMemo } from 'use-deep-compare';\n\ntype ImgArg = {\n  sizes?: string;\n  src?: string;\n  srcSet?: string;\n}\ntype SourceArg = {\n  sizes?: string;\n  src?: string;\n  srcSet?: string;\n  type?: string;\n}\ntype SourcesArg = SourceArg[]\nexport type UseProgressiveImageArg = {\n  img?: ImgArg | string;\n  sources?: SourcesArg;\n  ssr?: boolean;\n}\nexport type UseProgressiveImageReturn = [\n  boolean,\n  Event | string | undefined,\n]\n\nconst isBrowser = typeof window !== 'undefined' && window.document && window.document.createElement;\n\n/**\n * Necessary to prevent mismatch between the client and server on initial render in ssr mode.\n */\nconst initImages = isBrowser ? Array.from(document.images) : []; // Live array, need to convert to a regular\nlet normInitImages: string[] | undefined;\nconst getLazyInitImages = (): string[] => {\n  if (!normInitImages) {\n    normInitImages = initImages.map((img) => img.src).filter((src) => !src.startsWith('data:image'));\n  }\n  return normInitImages;\n};\nconst isInitImage = (src: string | undefined): boolean => getLazyInitImages().some(\n  (initImgSrc) => src && initImgSrc?.endsWith(src),\n);\nconst isInitSsr = (isSsrMode = false, src?: string): boolean => {\n  if (isSsrMode && src && isBrowser && document.readyState !== 'complete' && isInitImage(src)) {\n    return true;\n  }\n  return false;\n};\n\nfunction normArg(obj: ImgArg): Omit<ImgArg, 'srcSet'> | { 'srcset': ImgArg['srcSet'] }\nfunction normArg(obj: SourceArg): Omit<SourceArg, 'srcSet'> | { 'srcset': SourceArg['srcSet'] }[]\nfunction normArg(obj: SourceArg): Omit<SourceArg, 'srcSet'> | { 'srcset': SourceArg['srcSet'] }[]\nfunction normArg(obj: any): any {\n  const normObj = { ...obj, srcset: obj.srcSet };\n  delete normObj.srcSet;\n  Object.keys(normObj).forEach((key) => {\n    if (normObj[key] === undefined) {\n      delete normObj[key];\n    }\n  });\n  return normObj;\n}\n\nconst useProgressiveImage = ({\n  img: imgArg,\n  sources: sourcesArg,\n  ssr = false,\n}: UseProgressiveImageArg): UseProgressiveImageReturn => {\n  const [, setRerender] = useState(false);\n  const [errorEvent, setErrorEvent] = useState<Event | string | undefined>(undefined);\n\n  const rerender = useCallback(() => {\n    setRerender((prev) => !prev);\n  }, []);\n\n  const handleError = useCallback((event: Event | string) => {\n    setErrorEvent(event);\n  }, []);\n\n  // eslint-disable-next-line consistent-return\n  const image = useDeepCompareMemo<HTMLImageElement | undefined>(() => {\n    const src = typeof imgArg === 'string' ? imgArg : imgArg?.src;\n    if (src && isBrowser && !isInitSsr(ssr, src)) {\n      const img = document.createElement('img');\n\n      if (sourcesArg && sourcesArg.length > 0) {\n        const pic = document.createElement('picture');\n        sourcesArg?.forEach((sourceProps) => {\n          const source = document.createElement('source');\n          Object.assign(source, normArg(sourceProps));\n          pic.appendChild(source);\n        });\n        pic?.appendChild(img);\n      }\n\n      img.onload = rerender;\n      img.onerror = handleError;\n      Object.assign(img, normArg(typeof imgArg === 'string' ? { src: imgArg } : imgArg!)); // eslint-disable-line @typescript-eslint/no-non-null-assertion\n      return img;\n    }\n  }, [imgArg, sourcesArg, rerender, handleError, ssr]);\n\n  useEffect(() => () => {\n    if (image) {\n      image.onload = null;\n      image.onerror = null;\n    }\n  }, [image]);\n\n  if (image?.complete || !image) {\n    return [false, errorEvent];\n  }\n  return [true, errorEvent];\n};\n\nexport default useProgressiveImage;\n"],"names":["isBrowser","window","document","createElement","initImages","Array","from","images","normInitImages","getLazyInitImages","map","img","src","filter","startsWith","isInitImage","some","initImgSrc","endsWith","isInitSsr","isSsrMode","readyState","normArg","obj","normObj","srcset","srcSet","Object","keys","forEach","key","undefined","useProgressiveImage","imgArg","sourcesArg","sources","ssr","useState","setRerender","errorEvent","setErrorEvent","rerender","useCallback","prev","handleError","event","image","useDeepCompareMemo","length","pic","sourceProps","source","assign","appendChild","onload","onerror","useEffect","complete"],"mappings":"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"}